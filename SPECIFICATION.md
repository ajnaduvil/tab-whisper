# Tab Talk - Broadcast Channel Identity Communication Package Specification

## Table of Contents
- [1. Overview](#1-overview)
- [2. Core Concepts](#2-core-concepts)
- [3. Requirements](#3-requirements)
- [4. API Specification](#4-api-specification)
- [5. Message Protocol](#5-message-protocol)
- [6. Implementation Guidelines](#6-implementation-guidelines)
- [7. Usage Examples](#7-usage-examples)
- [8. Browser Compatibility](#8-browser-compatibility)
- [9. Error Handling](#9-error-handling)

## 1. Overview

This package provides a lightweight, browser-only framework for inter-tab/window communication using the Broadcast Channel API. It enables each browsing context (tab, window, iframe) to register a unique identity, discover other active contexts, and send messages to specific identities or broadcast messages to all.

### Key Features
- **Automatic Identity Management**: Each instance generates and maintains a unique identifier
- **Dual Identity System**: Support for both internal IDs and user-provided registration IDs
- **Peer Discovery**: Dynamic discovery and tracking of other active contexts
- **Flexible Messaging**: Support for both broadcast and direct messaging
- **Reliable Peer Management**: Advanced tab close detection and heartbeat system
- **Framework Agnostic**: Works with any JavaScript framework or vanilla JS
- **Browser-Only**: No Node.js dependencies or server-side functionality

## 2. Core Concepts

### 2.1 Identity
Each instance of the communication framework (representing a tab/window) has two types of identifiers:

#### Internal Identifier
- Automatically generated by the framework upon initialization
- Session-based and unique across all active contexts
- Used for internal framework operations and message routing
- Accessible via a read-only property

#### Registration ID
- Optional identifier supplied by the user/creator of the instance
- Can be used for application-specific identification and messaging
- Allows users to assign meaningful names or IDs to their instances
- Can be used for direct messaging and peer discovery

### 2.2 Channel
A named communication channel that all participating contexts subscribe to. Multiple channels can exist simultaneously, allowing for isolated communication groups.

### 2.3 Peers
A dynamic list of other active contexts (tabs/windows) currently connected to the same channel. The peer list:
- Excludes the current instance
- Updates automatically as tabs open and close
- Provides real-time presence information

### 2.4 Message Types
Predefined message types for internal framework operations and custom user-defined message types:
- **Internal**: Registration, disconnection, peer discovery
- **Custom**: User-defined message types for application-specific communication

## 3. Requirements

### 3.1 Browser Compatibility
- **Must** leverage the native BroadcastChannel API
- **Must** gracefully handle environments where BroadcastChannel is not supported
- **Must** be a browser-only package; no Node.js dependencies or functionality
- **Should** provide clear error messages for unsupported environments

### 3.2 Identity Management

#### Automatic ID Generation
- Each instance must automatically generate a unique, session-based internal ID upon initialization
- Internal ID should be accessible to the instance via a read-only property
- Internal ID format should be consistent and predictable
- Internal ID is used for framework-level operations and message routing

#### Registration ID Support
- Users should be able to optionally provide a registration ID during initialization
- Registration ID can be used for application-specific messaging and peer discovery
- Registration ID should be accessible via a read-only property
- Registration ID can be used as an alternative to internal ID for direct messaging

#### Self-Registration
- Upon initialization, each instance must automatically announce its presence to other contexts on the channel
- Registration should include both internal ID and registration ID (if provided)
- Registration should include metadata about the instance

#### Peer Discovery
- Instances must be able to discover and maintain a list of other active peers on the channel
- Peer list should include both internal IDs and registration IDs (if available)
- Peer list should be dynamically updated as tabs open and close
- Peer list should be accessible via a read-only property

#### Disconnection Handling
- When a tab/window closes, its corresponding instance must automatically signal its disconnection to other peers
- Other instances should update their peer lists accordingly
- Graceful cleanup of resources should occur

#### Advanced Peer Management
- **Tab Close Detection**: Use `beforeunload` event for immediate detection of tab close/refresh
- **Heartbeat System**: Send periodic heartbeat messages (every 5 seconds) to verify peer activity
- **Stale Peer Cleanup**: Remove peers that haven't responded for 15 seconds
- **Multiple Detection Methods**: Combine `beforeunload`, `visibilitychange`, and heartbeat for reliability
- **Automatic Recovery**: Handle cases where `beforeunload` doesn't fire (crashes, network issues)

### 3.3 Messaging

#### Broadcast Messaging
- Ability to send a message to all active contexts on the channel
- Should be efficient and avoid unnecessary processing

#### Direct Messaging
- Ability to send a message to a specific peer using either internal ID or registration ID
- Should validate target ID exists before sending
- Should support both internal ID and registration ID for message targeting

#### Structured Messages
- Messages should support arbitrary JSON-serializable data payloads
- Should include proper error handling for non-serializable data

#### Message Metadata
All messages (sent and received) must include:
- `from`: Sender ID (string)
- `to`: Recipient ID (string) or null for broadcast
- `type`: Custom string representing message type
- `payload`: JSON-serializable data
- `timestamp`: Message creation timestamp (automatically added by framework)

## 4. API Specification

### 4.1 Constructor/Initialization

The package should expose a primary class or function to instantiate the communication framework.

**Constructor Parameters:**
- `channelName` (string, required): Identifier for the communication channel
- `registrationId` (string, optional): User-provided identifier for the instance
- `onMessage` (function, optional): Callback for handling incoming messages
- `onPeerConnected` (function, optional): Callback when a new peer connects
- `onPeerDisconnected` (function, optional): Callback when a peer disconnects
- `onError` (function, optional): Callback for error handling

### 4.2 Properties

**Required Properties:**
- `id` (read-only string): Internal ID of current instance (automatically generated)
- `registrationId` (read-only string | null): User-provided registration ID (if provided)
- `peers` (read-only Set<string> or Array<string>): Set of active peer IDs (excluding self)
- `channelName` (read-only string): Name of the communication channel
- `isConnected` (read-only boolean): Connection status

### 4.3 Methods

#### send()
Sends a message to a specific peer or broadcasts to all peers.

**Parameters:**
- `targetId` (string | null): Recipient ID (internal ID or registration ID), or null for broadcast
- `type` (string): Message type identifier
- `payload` (any): JSON-serializable data

**Throws:** Error if targetId is invalid or payload is not serializable

#### on()
Registers a listener for specific message types or internal events.

**Parameters:**
- `eventType` (string): Event type to listen for
- `callback` (function): Handler function

**Supported Events:**
- `'message'`: Custom message received
- `'peerConnected'`: New peer joined
- `'peerDisconnected'`: Peer left
- `'error'`: Error occurred

#### off()
Removes a previously registered event listener.

**Parameters:**
- `eventType` (string): Event type to remove listener from
- `callback` (function): Handler function to remove

#### close()
Disconnects the instance from the channel and cleans up resources.

## 5. Message Protocol

### 5.1 Message Structure

All messages (sent and received) must include:
- `from`: Sender ID (string) - can be internal ID or registration ID
- `to`: Recipient ID (string) or null for broadcast
- `type`: Custom string representing message type
- `payload`: JSON-serializable data
- `timestamp`: Message creation timestamp (automatically added by framework)

### 5.2 Internal Message Types

The framework should handle internal message types for:
- **Registration**: When a new instance joins the channel
- **Disconnection**: When an instance leaves the channel
- **Peer Discovery**: For discovering existing peers on the channel
- **Heartbeat**: For verifying peer activity and detecting stale peers
- **Heartbeat Response**: Response to heartbeat verification requests

### 5.3 Custom Message Types

Users should be able to define custom message types for application-specific communication.

## 6. Implementation Guidelines

### 6.1 ID Generation
- Use a combination of timestamp and random string
- Ensure uniqueness across multiple instances
- Consider using `crypto.randomUUID()` if available

### 6.2 Error Handling
- Validate all inputs
- Provide meaningful error messages
- Handle BroadcastChannel API unavailability
- Implement graceful degradation

### 6.3 Performance Considerations
- Minimize message overhead
- Implement efficient peer list management
- Use appropriate data structures for lookups
- Consider message queuing for high-frequency communication
- Optimize heartbeat frequency (5-second intervals) to balance responsiveness and performance
- Implement efficient stale peer detection and cleanup

### 6.4 Security Considerations
- Validate message sources
- Sanitize incoming data
- Consider implementing message signing for sensitive applications
- Document security limitations

## 7. Usage Considerations

The package should be framework-agnostic (usable with React, Vue, Angular, or plain JavaScript).

Clear examples for common use cases should be provided in the documentation, including:
- Direct messaging between specific tabs
- Broadcast messaging to all tabs
- Shared state synchronization
- Presence detection and user tracking
- Real-time collaboration with accurate peer management
- Reliable peer cleanup and recovery mechanisms

## 8. Browser Compatibility

### 8.1 Supported Browsers
- Chrome 54+
- Firefox 38+
- Safari 15.4+
- Edge 79+

### 8.2 Feature Detection

The package should provide clear guidance on detecting BroadcastChannel API support and handling unsupported environments. No polyfill or fallback support is required for older browsers.



## 9. Error Handling

### 9.1 Common Error Scenarios

The package should handle common error scenarios including:
- BroadcastChannel API unavailability
- Invalid message data (non-serializable payloads)
- Invalid target peer IDs
- Network connectivity issues
- Tab crashes or unexpected closures
- Stale peer detection and cleanup
- Heartbeat timeout scenarios

### 9.2 Error Types

The package should define appropriate error types for different failure scenarios and provide meaningful error messages.

---

## Version History

- **v1.0.0**: Initial specification
  - Core identity management
  - Peer discovery
  - Broadcast and direct messaging
  - Event-driven API
  - Advanced peer management with tab close detection
  - Heartbeat system for reliable peer verification
  - Dual identity system (internal and registration IDs)

## Contributing

This specification is open for review and improvement. Please ensure all changes maintain backward compatibility and follow the established patterns.

## License

[Specify license information] 